<!DOCTYPE html>
<html>
    <head>
        <title>
            Javascript-Snake
        </title>
    </head>
    <body>
        <canvas id="SnakeCanvas" width="400" height="400" style="border:1px solid #000000"></canvas>
        <script>
            const Direction = {
                UP    : "UP",
                DOWN  : "DOWN",
                LEFT  : "LEFT",
                RIGHT : "RIGHT"
            };

            const Triangle = {
                fill : function(centerX, centerY, size, direction) {
                    var canvas = document.getElementById("SnakeCanvas");
                    var context = canvas.getContext("2d");
                    context.beginPath();

                    this.prepare(centerX, centerY, size, direction, context);

                    context.fill();
                    context.closePath();
                },
                prepare : function(centerX, centerY, size, direction, context) {
                    var halfSize = size/2;

                    switch (direction) {
                        case Direction.UP:
                            context.moveTo(centerX, centerY - halfSize);
                            context.lineTo(centerX + halfSize, centerY + halfSize);
                            context.lineTo(centerX - halfSize, centerY + halfSize);
                            context.lineTo(centerX, centerY - halfSize);
                            break;
                        case Direction.DOWN:
                            context.moveTo(centerX, centerY + halfSize);
                            context.lineTo(centerX + halfSize, centerY - halfSize);
                            context.lineTo(centerX - halfSize, centerY - halfSize);
                            context.lineTo(centerX, centerY + halfSize);
                            break;
                        case Direction.LEFT:
                            context.moveTo(centerX - halfSize, centerY);
                            context.lineTo(centerX + halfSize, centerY - halfSize);
                            context.lineTo(centerX + halfSize, centerY + halfSize);
                            context.lineTo(centerX - halfSize, centerY);
                            break;
                        case Direction.RIGHT:
                            context.moveTo(centerX + halfSize, centerY);
                            context.lineTo(centerX - halfSize, centerY + halfSize);
                            context.lineTo(centerX - halfSize, centerY - halfSize);
                            context.lineTo(centerX + halfSize, centerY);
                            break;
                        default:
                            break;
                    }
                },
                stroke : function(centerX, centerY, size, direction) {
                    var canvas = document.getElementById("SnakeCanvas");
                    var context = canvas.getContext("2d");
                    context.beginPath();
                    
                    this.prepare(centerX, centerY, size, direction, context);

                    context.stroke();
                    context.closePath();
                }
            }

            function Food(centerX, centerY) {
                this.center = { x : centerX, y : centerY },
                this.radius = 8,
                this.draw = function() {
                    var canvas = document.getElementById("SnakeCanvas");
                    var context = canvas.getContext("2d");
                    context.beginPath();

                    context.arc(this.center.x, this.center.y, this.radius, 0, 2 * Math.PI);
                    let saveFillStyle = context.fillStyle;
                    context.fillStyle = "yellow";
                    context.strokeStyle = "black";
                    context.fill();
                    context.stroke();

                    context.fillStyle = saveFillStyle;

                    context.closePath();
                }
            }

            var grub = new Food(210, 210);

            const grid = {
                squareSize : 20,
                draw : function(context, width, height) {
                    let saveFillStyle = context.fillStyle;

                    context.beginPath();

                    // Draw background color
                    context.fillStyle = "#996633";
                    context.rect(0, 0, width, height);
                    context.fill();

                    context.closePath();

                    // Draw Grid
                    
                    context.fillStyle = "#999966";
                    for (let col = 0; col < width/this.squareSize; col++) {
                        for (let row = 0; row < height/this.squareSize; row++) {
                            if((col + row) % 2 == 0) {
                                context.beginPath();
                                context.rect(col * this.squareSize, 
                                    row * this.squareSize, 
                                    this.squareSize, 
                                    this.squareSize);
                                context.fill();
                                context.closePath();
                            } 
                        }
                    }

                    
                    context.closePath();
                    context.fillStyle = saveFillStyle;
                    return;
                }
            }

            function SnakeSegment(centerX, CenterY) {
                this.center = { x : centerX, y : centerY },
                this.radius = 8; 
                this.next = null;
                this.draw = function() {
                    var canvas = document.getElementById("SnakeCanvas");
                    var context = canvas.getContext("2d");
                    context.beginPath();

                    context.arc(this.center.x, this.center.y, this.radius, 0, 2 * Math.PI);
                    let saveFillStyle = context.fillStyle;
                    context.fillStyle = "green";
                    context.strokeStyle = "black";
                    context.fill();
                    context.stroke();

                    context.fillStyle = saveFillStyle;

                    context.closePath();

                    if (this.next != null) {
                        this.next.draw();
                    }
                }
                this.move = function(prevX, prevY) {


                    if (this.next != null) {
                        this.next.move();
                    }
                }

            }

            var snake = {
                center : { x : 110, y : 210 },
                dx : 0,
                dy : 0,
                size : 16,
                direction : Direction.DOWN,
                speed : 4,
                checkCollision : function() {
                    var canvas = document.getElementById("SnakeCanvas");
                    var halfSize = this.size/2;
                    var topLeft = { 
                        x : this.center.x - halfSize,
                        y : this.center.y - halfSize
                    };
                    var bottomRight = {
                        x : this.center.x + halfSize,
                        y : this.center.y + halfSize
                    }

                    // treat snake head and grubs as circles for simplicity
                    let snakeRadius = snake.size/2;

                    // there is a collision if the distance is less than the sum of the radii
                    let distance = Math.sqrt( 
                        Math.pow(this.center.x - grub.center.x, 2)
                        + Math.pow(this.center.y - grub.center.y, 2)
                    );

                    var context = canvas.getContext("2d");
                    if(distance < (snakeRadius + grub.radius)) {
                        context.font = "15px Arial";
                        context.fillText("Collision", 100, 40);
                    }


                    // check if snake head is still on canvas
                    if(topLeft.x < 0) {
                        this.dx = 0;
                        this.dy = 0;
                        this.center.x = 0 + halfSize;
                    } 
                    else if (topLeft.y < 0) {
                        this.dx = 0;
                        this.dy = 0;
                        this.center.y = 0 + halfSize;
                    } 
                    else if (bottomRight.x > canvas.width) {
                        this.dx = 0;
                        this.dy = 0;
                        this.center.x = canvas.width - halfSize;
                    }
                    else if (bottomRight.y > canvas.width) {
                        this.dx = 0;
                        this.dy = 0;
                        this.center.y = canvas.width - halfSize;
                    }
                },
                draw : function() {
                    Triangle.fill(this.center.x, this.center.y, this.size, this.direction);
                    return;
                },
                move : function () {
                    this.center.x += this.dx;
                    this.center.y += this.dy;   
                },
                setDirection : function(direction) {
                    switch (direction) {
                        case Direction.UP:
                            if (this.direction == Direction.DOWN)
                                break;
                            this.dy = -this.speed;
                            this.dx = 0;
                            this.direction = direction
                            break;
                        case Direction.DOWN:
                            if (this.direction == Direction.UP)
                                break;
                            this.dy = this.speed;
                            this.dx = 0;
                            this.direction = direction
                            break;
                        case Direction.LEFT:
                            if (this.direction == Direction.RIGHT)
                                break;
                            this.dy = 0;
                            this.dx = -this.speed;
                            this.direction = direction
                            break;
                        case Direction.RIGHT:
                            if (this.direction == Direction.LEFT)
                                break;
                            this.dy = 0;
                            this.dx = this.speed;
                            this.direction = direction
                            break;
                        default:
                            break;
                    }
                }
            };
        
            document.addEventListener('keydown', function(e) {
                var code = e.which || e.keyCode;
                if (code == '38') {
                    // Up
                    snake.setDirection(Direction.UP);
                }
                else if (code == '40') {
                    // Down
                    snake.setDirection(Direction.DOWN);
                }
                else if (code == '37') {
                    // Left
                    snake.setDirection(Direction.LEFT);
                }
                else if (code == '39') {
                    // Right
                    snake.setDirection(Direction.RIGHT);
                }
            });

            function draw() {
                var canvas = document.getElementById("SnakeCanvas");
                var context = canvas.getContext("2d");

                context.clearRect(0, 0, canvas.width, canvas.height);

                
                grid.draw(context, canvas.width, canvas.height);

                snake.move();

                snake.draw();
                grub.draw();

                snake.checkCollision();
                
            }

            setInterval(draw, 20);
        </script>
    </body>
</html>